### 流程图

1. 用户接入流程

![avatar](../image/access.png)

* 步骤1-4,需要通过app-server获取token, app-server 需在之前授权并获得有效的key和secret.

> app-server需另行搭建，只中转token请求，目的是 key 和 secret 不在客户端上保存，不安全

* router服务会验证传入的key的合法性, 成功之后才可给予接入token.
* 接入规则:

> 需要在请求中加入4个Header
```
AppId: 对应授权key
Nonce: 随机串
Timestamp: 时间值
Sign: 数字签名，算法如下

Sign = SHA1(AppSecret + Nonce + Timestamp)
```
* 步骤5，客户端请求接入，需带上有效token.
* 步骤6，router服务会根据系统负载情况，分配最合适的access节点地址
* 步骤7，客户端长链接接入到access节点，并发送登录信息
* 步骤8，客户端登录IM系统完成，可接入IM服务

2. 单聊消息发送

![avatar](../image/single.png)

* 步骤1，用户发送单聊消息
* 步骤2，接入服务转上行消息
* 步骤3，单聊服务做统一处理，存储消息并回复上行成功ACK给接入服务
* 步骤4，接入服务返回，表示用户发送成功，并携带服务器提供的消息ID和存储时间
* 步骤5，单聊服务转下行，找到目的用户所处的 接入服务器，并转发消息。
* 步骤6，接入服务下发消息至目的用户（推模式）
* 步骤7，目的用户确认接收完成

> 注：步骤6，7， 同样可以采用拉模式，即接入服务下发拉取通知，让用户自行拉取消息。

3. 群聊消息发送

![avatar](../image/group.png)

* 步骤1，用户发送群聊消息
* 步骤2，接入服务转上行消息
* 步骤3，群组服务自身完成群组验证
* 步骤4，群组服务存储消息
* 步骤5，群组服务发送上行成功确认
* 步骤6，接入服务返回，表示用户发送成功，并携带服务器提供的消息ID和存储时间
* 步骤7，群聊服务对群中所有用户做分发，找到对应的群用户所处的 接入服务器，并转发消息
* 步骤8，接入服务下发消息至目的用户
* 步骤9，目的用户确认接收完成